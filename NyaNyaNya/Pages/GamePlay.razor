@page "/gameplay/{IsPlayMusic:bool}/{PlanetId:int}"

<div class="d-flex flex-column justify-content-center align-items-center h-100 w-100 game-bg"
    style="@($"background: url('images/backgrounds/background-{PlanetId}.jpg'); background-size: 100% 100%;")">
    <span class="position-absolute game-box energy-box">
        <img src="images/icons/thunder.png" alt="thunder" style="width: 45px; height: 70px;"> @energy
    </span>

    <div class="@($"menu-frame d-flex justify-content-between align-items-center position-absolute {menuFrameClass}")" style="z-index: 10;">
        <img class="cursor-pointer close-icon" src="images/icons/exit.jpg" @onclick="@SwitchMenuFrame">
        <NavLink href="@($"/{IsPlayMusic}")" class="cursor-pointer">
            <span class="exit-button justify-content-center cursor-pointer">Exit</span>
        </NavLink>
    </div>

    <span class="position-absolute game-box config-box cursor-pointer justify-content-center" @onclick="@SwitchMenuFrame">
        <img src="images/icons/pixel-paw.png" alt="paw" style="height: 90%; width: 90%;"/>
    </span>

    <div class="castle"></div>

    @for(int i = 0; i < platformsY.Count; i++)
    {
        @for (int j = 0; j < platformsX.Count; j++)
        {
            var y = i;
            var x = j;
            int platformVersion = 0;

            if (x % 2 == 0)
            {
                platformVersion = y % 2 == 0 ? 1 : 2;
            }
            else
            {
                platformVersion = y % 2 == 0 ? 2 : 1;
            }

            <div class="platform platform-@platformVersion position-absolute" style="@($"top: {platformsY[y]}px; left: {platformsX[x]}px;")" @onclick="@(e => PlaceCat(e, x, y))"></div>
        }
    }

    @for(int i = 0; i < platformsY.Count; i++)
    {
        @for (int j = 0; j < platformsX.Count; j++)
        {
            var y = i;
            var x = j;
            var cat = catsOnField[y, x];

            if (cat != null && cat.Name != null && cat.Name != "")
            {
                <img class="position-absolute" src="@cat.Image" 
                style="@($"top: {cat.Y}px; left: {cat.X}px; width: {cat.Width}px; height: {cat.Height}px;")"/>
                
                for(int k = 0; k < cat.Projectiles.Length; k++)
                {
                    if (!cat.Projectiles[k]) continue;
                    <p style="color: white; position: absolute; bottom: 0; left: 0;">
                        @cat.Projectiles[k]
                    </p>
                    switch(cat.Name)
                    {
                        case "Space Cat":
                            break;
                        case "Wise Cat":
                            <div class="position-absolute" style="@($"top: {cat.Y}px; left: {cat.X}px;")">
                                <img class="position-absolute animate-battery" src="images/projectiles/battery.png"
                                style="@($"width: 30px; height: 30px;")" />
                            </div>
                            break;
                        default:
                            Console.WriteLine("Bug");
                            break;
                    }
                }

            }
        }
    }

    @for(int i = 0; i < ratsOnField.Length; i++)
    {
        var ratIndex = i;
        var rat = ratsOnField[ratIndex];

        if (rat != null)
        {
            <img class="position-absolute" src="@rat.Image" 
            style="@($"top: {rat.Y}px; left: {rat.X}px; width: {rat.Width}px; height: {rat.Height}px;")"/>
        }
    }

    <div class="d-flex justify-content-center align-items-center position-absolute center-absolute" style="gap: 10px; bottom: 0;">
        @for (int i = 0; i < 6; i++)
        {
            var selectedDrawer = i;

            <div class="d-flex flex-column @containerClasses[selectedDrawer]" style="height: 80px; width: 70px; z-index: 5;" @onclick="@(e => SelectCat(e, selectedDrawer))">
                    <div class="cat-container d-flex align-items-center justify-content-center" style="height: 80%; width: 100%;">
                        <img src="@catDrawer[i].Image" style="width: 75%; height: 75%;" />
                    </div>
                    <span class="cat-container d-flex align-items-center justify-content-center" style="height: 20%; width: 100%; font-size: 5px;">@catDrawer[i].Name</span>
            </div>
        }
    </div>

    <p style="color: white; position: absolute; bottom: 0; left: 0;">
        @gameSeconds
    </p>
</div>

<MusicPlayer Track="Skate" PlayMusic="IsPlayMusic" />

@code {
    [Parameter]
    public bool IsPlayMusic { get; set; }

    [Parameter]
    public int PlanetId { get; set; }

    [Parameter]
    public int CatNames { get; set; }

    private int energy = 1;
    protected float gameSpeed = 0.125f;
    protected float gameSeconds = 0;

    private List<int> platformsX = new List<int>();
    private List<int> platformsY = new List<int>();

    private Cat[,]? catsOnField = new Cat[4,8];
    private Rat[]? ratsOnField = new Rat[10];
    private bool[] ratsCanFall = new bool[10];

    private int ratFallIndex;
    private bool firstWaveLoop = true;

    private string menuFrameClass = "menu-frame-off";
    private bool menuFrameOn = false;

    private List<string> containerClasses = new List<string>();
    private string containerSelected = "drawer-selected";
    private Cat selectedCat;
    private bool catIsSelected = false;

    private bool isWave = false;

    private List<Cat> catDrawer = new List<Cat>();
    private List<Rat> rats = new List<Rat>();

    string rootpath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "wwwroot");

    public GamePlay()
    {
        using (StreamReader r = new StreamReader(rootpath + "/database/selected-cats.json"))
        {
            string json = r.ReadToEnd();
            var catsTemp = JsonConvert.DeserializeObject<List<Cat>>(json);
            catDrawer = catsTemp;
        }

        using (StreamReader r = new StreamReader(rootpath + "/database/rats.json"))
        {
            string json = r.ReadToEnd();
            var tempRats = JsonConvert.DeserializeObject<List<Rat>>(json);

            rats = tempRats.Where(r => r.Worlds.Contains(PlanetId)).ToList();
        }

        File.WriteAllText(rootpath + "/database/selected-cats.json", string.Empty);

        for (int i = 0; i < 4; i++)
        {
            platformsY.Add(30 + (i * 80));
        }

        for (int i = 0; i < 8; i++)
        {
            platformsX.Add(180 + (i * 80));
        }

        for (int i = 0; i < 6; i++)
        {
            containerClasses.Add("");
        }


        for (int i = 0; i < platformsX.Count; i++)
        {
            for (int j = 0; j < platformsY.Count; j++)
            {
                catsOnField[j,i] = new Cat() { Name = "", Image = "" };
            }
        }

        selectedCat = new Cat() { Name = "", Image = "" };

        for(int i = 0; i < 10; i++)
        {
            ratsOnField[i] = new Rat(rats[new Random().Next(0, rats.Count)]);
            ratsCanFall[i] = false;
        }

        ratFallIndex = 0;
        ratsOnField[0] = new Rat(rats[0]);
        ratsOnField[1] = new Rat(rats[0]);

        ratsOnField = ratsOnField.OrderBy(r => r.Id).ToArray();
    }

    protected void SwitchMenuFrame()
    {
        menuFrameOn = !menuFrameOn;
        menuFrameClass = menuFrameOn ? "" : "menu-frame-off";
    }

    private void SelectCat(MouseEventArgs e, int selectedDrawer)
    {
        for(int i = 0; i < 6; i++)
        {
            containerClasses[i] = "";
        }

        containerClasses[selectedDrawer] = containerSelected;

        selectedCat = catDrawer[selectedDrawer];
        catIsSelected = true;
    }

    private void PlaceCat(MouseEventArgs e, int x, int y)
    {
        if (catsOnField[y, x] == null || catsOnField[y, x].Name == "")
        {
            if (selectedCat.Price <= energy)
            {
                catsOnField[y, x] = new Cat(selectedCat);
                catsOnField[y, x].X = platformsX[x] + 12;
                catsOnField[y, x].Y = platformsY[y];
                energy -= selectedCat.Price;
            }
        }

        catIsSelected = false;
        for (int i = 0; i < 6; i++)
        {
            containerClasses[i] = "";
        }
        selectedCat = new Cat() { Name = "", Image = "" };
    }

    private void ReleaseProjectiles()
    {
        for(int i = 0; i < platformsX.Count; i++)
        {
            for(int j = 0; j < platformsY.Count; j++)
            {
                if (catsOnField[j, i].Name == null || catsOnField[j, i].Name == "") continue;
                switch(catsOnField[j,i].Name)
                {
                    case "Wise Cat":
                        if(gameSeconds % catsOnField[j,i].Recharge == 0)
                        {
                            catsOnField[i, j].Projectiles[catsOnField[i, j].ProjectileIndex] = true;
                            if(catsOnField[i, j].ProjectileIndex < catsOnField[i, j].Projectiles.Length - 1)
                            {
                                catsOnField[i, j].ProjectileIndex++;
                            }
                            else
                            {
                                catsOnField[i, j].ProjectileIndex = 0;
                            }
                        }

                        break;
                }
            }
        }
    }

    private void AnimateRatsFall()
    {
        bool firstLoop = true;
        for(int i = 0; i < ratsOnField.Length; i++)
        {
            if(!isWave)
            {
                if(gameSeconds % 10 == 0 && ratFallIndex < ratsOnField.Length && firstLoop)
                {
                    ratsCanFall[ratFallIndex] = true;
                    ratFallIndex++;
                    firstLoop = false;
                }
            }
            else
            {
                if(firstWaveLoop)
                {
                    ratsCanFall[i] = true;
                    if(i == ratsOnField.Length - 1)
                    {
                        firstWaveLoop = false;
                    }
                }
            }

            if (ratsCanFall[i])
            {
                ratsOnField[i].Y += 3;
            }

            if ((ratsOnField[i].Y >= platformsY[0] - 3 && ratsOnField[i].Y <= platformsY[0] + 3) ||
            (ratsOnField[i].Y >= platformsY[1] - 3 && ratsOnField[i].Y <= platformsY[1] + 3) ||
            (ratsOnField[i].Y >= platformsY[2] - 3 && ratsOnField[i].Y <= platformsY[2] + 3)
            )
            {
                if (new Random().Next(0, 5) == 0)
                {
                    ratsCanFall[i] = false;
                }
            }

            if ((ratsOnField[i].Y >= platformsY[3] - 3 && ratsOnField[i].Y <= platformsY[3] + 3))
            {
                ratsCanFall[i] = false;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            while (true)
            {
                await Task.Delay((int)(1000 * gameSpeed));

                AnimateRatsFall();
                ReleaseProjectiles();

                gameSeconds += gameSpeed;
                StateHasChanged();
            }
        }
    }
}